{% extends "base.html" %}
{% block content %}

<style>
/* Glass container */
.glass-container {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 2rem;
    color: #fff;
}

/* Tabella glass */
.glass-table {
    width: 100%;
    border-collapse: collapse;
}

.glass-table th, .glass-table td {
    padding: 0.75rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.glass-table thead {
    background: rgba(255, 255, 255, 0.2);
}

.glass-table tbody tr:hover {
    background: rgba(255, 255, 255, 0.1);
}

/* Modal custom */
.fade-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1050;
}

.fade-modal.show {
    display: flex;
}

.modal-content {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    color: #fff;
    border-radius: 15px;
    max-width: 600px;
    padding: 2rem;
}
</style>

<div class="container my-5">
    <div class="glass-container shadow" style="max-width: 1100px; margin: auto;">
        <h2 class="mb-4 text-center">Nuovo Ordine</h2>

        {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
        {% endif %}

        <form method="POST" id="formNuovoOrdine">
            <!-- Tavolo -->
            <div class="mb-3">
                <label class="form-label">Tavolo</label>
                <select name="id_tavolo" class="form-select" required>
                    {% for tavolo in tavoli %}
                    <option value="{{ tavolo['id_tavolo'] }}">{{ tavolo['nome_tavolo'] }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Operatore -->
            <div class="mb-3">
                <label class="form-label">Operatore</label>
                <select name="id_operatore" class="form-select" required>
                    {% for op in operatori %}
                    <option value="{{ op['id_operatore'] }}">{{ op['nome'] }} {{ op['cognome'] }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Articoli -->
            <h4 class="mt-4 mb-3">Articoli</h4>
            <div class="table-responsive">
                <table class="table-container glass-table" id="tabellaArticoli">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Prezzo</th>
                            <th>Quantit√†</th>
                            <th>Ingredienti</th>
                            <th>Personalizza</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for art in articoli %}
                        <tr data-id="{{ art['id_articolo'] }}">
                            <td>{{ art['nome'] }}</td>
                            <td>‚Ç¨ {{ "%.2f"|format(art['prezzo']) }}</td>
                            <td>
                                <input type="number" name="quantita_{{ art['id_articolo'] }}" min="0" value="0" class="form-control">
                            </td>
                            <td class="ingredienti-colonna text-white" data-loaded="false">Caricamento...</td>
                            <td>
                                <button type="button" 
                                        class="btn btn-outline-primary btn-sm btnPersonalizza" 
                                        data-id="{{ art['id_articolo'] }}"
                                        data-nome="{{ art['nome'] }}">
                                    üñâ
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pulsanti -->
            <div class="mt-4 text-end">
                <button type="button" class="btn btn-danger me-2" onclick="window.history.back()">‚Üê Indietro</button>
                <button type="submit" class="btn btn-success">Crea Ordine</button>
            </div>

            <!-- Modal custom -->
            <div class="fade-modal" id="modalPersonalizza">
                <div class="modal-content">
                    <h5 id="nomeArticolo"></h5>

                    <div class="mb-3">
                        <label>Quante unit√† vuoi modificare?</label>
                        <input type="number" id="quantitaModifica" class="form-control" min="1">
                    </div>

                    <hr>
                    <h6>Ingredienti esistenti</h6>
                    <div id="ingredienti-lista" class="mt-3"></div>
                    <hr>
                    <h6>Aggiungi ingredienti</h6>
                    <div class="input-group mb-3">
                        <select id="aggiungiIngredienteSelect" class="form-select"></select>
                        <button class="btn btn-success" type="button" id="btnAggiungiIngrediente">Aggiungi</button>
                    </div>
                    <div id="ingredienti-aggiunti"></div>

                    <div class="mt-3 text-end">
                        <button type="button" class="btn btn-secondary" id="chiudiModal">Chiudi</button>
                        <button type="button" class="btn btn-primary" id="btnSalvaPersonalizzazione">Salva modifiche</button>
                    </div>
                </div>
            </div>

        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let articoloIdCorrente = null;
    let rigaCorrente = null;
    let ingredientiDefault = [];
    let indiceRighe = 0;

    // Assegna indici alle righe
    document.querySelectorAll('#tabellaArticoli tbody tr').forEach(tr => {
        tr.dataset.index = indiceRighe;
        const idArt = tr.dataset.id;
        const inputQta = tr.querySelector('input[type="number"]');
        inputQta.name = `quantita_${indiceRighe}`;
        if (!tr.querySelector(`input[name="id_articolo_${indiceRighe}"]`)) {
            const inputIdArt = document.createElement('input');
            inputIdArt.type = 'hidden';
            inputIdArt.name = `id_articolo_${indiceRighe}`;
            inputIdArt.value = idArt;
            tr.appendChild(inputIdArt);
        }
        indiceRighe++;
    });

    function caricaIngredientiTabella() {
        document.querySelectorAll('#tabellaArticoli tbody tr').forEach(tr => {
            const id = tr.dataset.id;
            const tdIngredienti = tr.querySelector('.ingredienti-colonna');
            fetch(`/articolo/${id}/ingredienti`)
                .then(res => res.json())
                .then(data => {
                    tdIngredienti.textContent = data.length ? data.map(i => i.nome).join(", ") : "Nessun ingrediente";
                    tdIngredienti.dataset.loaded = "true";
                    if (!tr.dataset.ingredienti) tr.dataset.ingredienti = JSON.stringify(data.map(i => i.id_ingrediente));
                })
                .catch(err => { console.error(err); tdIngredienti.textContent = "Errore"; });
        });
    }
    caricaIngredientiTabella();

    const modalEl = document.getElementById('modalPersonalizza');

    document.body.addEventListener('click', function(e) {
        if (e.target.closest('.btnPersonalizza')) {
            const btn = e.target.closest('.btnPersonalizza');
            articoloIdCorrente = btn.dataset.id;
            rigaCorrente = btn.closest('tr');
            document.getElementById('nomeArticolo').textContent = btn.dataset.nome;

            const qta = parseInt(rigaCorrente.querySelector('input[type="number"]').value) || 1;
            const quantInput = document.getElementById('quantitaModifica');
            quantInput.value = qta;
            quantInput.max = qta;

            fetch(`/articolo/${articoloIdCorrente}/ingredienti`).then(r => r.json()).then(data => {
                ingredientiDefault = data;
                const lista = document.getElementById('ingredienti-lista');
                let savedIds = [];
                if (rigaCorrente.dataset.ingredienti) {
                    try { savedIds = JSON.parse(rigaCorrente.dataset.ingredienti); } catch(e) { savedIds = []; }
                } else { savedIds = data.map(i => i.id_ingrediente); }

                lista.innerHTML = data.length
                    ? data.map(ing => `<div class="form-check"><input class="form-check-input" type="checkbox" value="${ing.id_ingrediente}" ${savedIds.includes(ing.id_ingrediente) ? 'checked' : ''}><label class="form-check-label">${ing.nome}</label></div>`).join('')
                    : '<p class="text-muted">Nessun ingrediente associato.</p>';
            });

            fetch(`/ingredienti/disponibili/${articoloIdCorrente}`).then(r => r.json()).then(data => {
                const select = document.getElementById('aggiungiIngredienteSelect');
                select.innerHTML = data.length ? data.map(ing => `<option value="${ing.id_ingrediente}">${ing.nome}</option>`).join('') : '<option disabled>Nessun ingrediente disponibile</option>';
            });

            document.getElementById('ingredienti-aggiunti').innerHTML = '';
            modalEl.classList.add('show');
        }
    });

    document.getElementById('btnAggiungiIngrediente').addEventListener('click', function() {
        const select = document.getElementById('aggiungiIngredienteSelect');
        const id = select.value;
        const nome = select.options[select.selectedIndex]?.text;
        if (!id) return;
        document.getElementById('ingredienti-aggiunti').innerHTML += `<div class="form-check"><input class="form-check-input" type="checkbox" value="${id}" checked><label class="form-check-label">${nome} (aggiunto)</label></div>`;
        select.remove(select.selectedIndex);
    });

    function aggiornaHiddenIngredienti(tr, ingredientiIds) {
        const indice = tr.dataset.index;
        const form = document.getElementById('formNuovoOrdine');
        form.querySelectorAll(`input[name="ingredienti_${indice}[]"]`).forEach(el => el.remove());
        ingredientiIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = `ingredienti_${indice}[]`;
            input.value = id;
            form.appendChild(input);
        });
    }

    function nomiIngredientiDaIds(ids) {
        return ids.map(id => {
            const ing = ingredientiDefault.find(i => i.id_ingrediente == id);
            return ing ? ing.nome : `(ingrediente sconosciuto ${id})`;
        });
    }

    document.getElementById('btnSalvaPersonalizzazione').addEventListener('click', function() {
        const qtaTotale = parseInt(rigaCorrente.querySelector('input[type="number"]').value);
        let qtaModifica = parseInt(document.getElementById('quantitaModifica').value);
        if (qtaModifica > qtaTotale) qtaModifica = qtaTotale;

        const ingredientiIds = Array.from(document.querySelectorAll('#ingredienti-lista input:checked, #ingredienti-aggiunti input:checked')).map(el => el.value);

        if (qtaModifica < qtaTotale) {
            const clone = rigaCorrente.cloneNode(true);
            clone.dataset.index = indiceRighe;
            clone.querySelector('input[type="number"]').name = `quantita_${indiceRighe}`;
            clone.querySelector('input[type="number"]').value = qtaModifica;

            const inputIdArtClone = clone.querySelector(`input[name^="id_articolo"]`) || (() => {
                const i = document.createElement('input');
                i.type = 'hidden'; clone.appendChild(i); return i;
            })();
            inputIdArtClone.name = `id_articolo_${indiceRighe}`;
            inputIdArtClone.value = clone.dataset.id;

            clone.dataset.ingredienti = JSON.stringify(ingredientiIds);
            aggiornaHiddenIngredienti(clone, ingredientiIds);
            clone.querySelector('.ingredienti-colonna').textContent = nomiIngredientiDaIds(ingredientiIds).join(", ");

            rigaCorrente.querySelector('input[type="number"]').value = qtaTotale - qtaModifica;
            let origIds = [];
            try { origIds = JSON.parse(rigaCorrente.dataset.ingredienti); } catch(e) {}
            rigaCorrente.querySelector('.ingredienti-colonna').textContent = nomiIngredientiDaIds(origIds).join(", ");
            aggiornaHiddenIngredienti(rigaCorrente, origIds);

            rigaCorrente.after(clone);
            indiceRighe++;
        } else {
            rigaCorrente.dataset.ingredienti = JSON.stringify(ingredientiIds);
            rigaCorrente.querySelector('.ingredienti-colonna').textContent = nomiIngredientiDaIds(ingredientiIds).join(", ");
            aggiornaHiddenIngredienti(rigaCorrente, ingredientiIds);
        }

        modalEl.classList.remove('show');
    });

    document.getElementById('chiudiModal').addEventListener('click', function() {
        modalEl.classList.remove('show');
    });

    document.getElementById('formNuovoOrdine').addEventListener('submit', function() {
        const form = this;
        form.querySelectorAll('input[name^="ingredienti_"]').forEach(el => el.remove());
        document.querySelectorAll('#tabellaArticoli tbody tr').forEach(tr => {
            const qta = parseInt(tr.querySelector('input[type="number"]').value) || 0;
            if (qta <= 0) return;
            let savedIds = [];
            if (tr.dataset.ingredienti) try { savedIds = JSON.parse(tr.dataset.ingredienti); } catch(e) {}
            aggiornaHiddenIngredienti(tr, savedIds);
        });
    });
});
</script>

{% endblock %}
