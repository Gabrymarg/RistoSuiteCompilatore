{% extends "base.html" %}
{% block content %}
<style>
.fade-modal h3 { margin-top:0; text-align:center; }
.modal-content label { display:block; margin-top:10px; margin-bottom:4px; }
.modal-content input, .modal-content select { width:100%; padding:6px; border-radius:6px; border:1px solid #555; background:#333; color:white; }
</style>
<div class="container mb-3">
  <h2 class="align-items-center text-center">üçΩÔ∏è MAPPATURA TAVOLI üçΩÔ∏è</h2>
  <div class="container d-flex justify-content-between gap-1" id="controls">
  <button class="btn btn-success mb-3 mx-5" onclick="document.getElementById('bgInput').click()">üñº Cambia Planimetria</button>
  <div>
  <button class="btn btn-success mb-3" onclick="openAddTableModal()">+ Aggiungi Tavolo</button>
  <button class="btn btn-success mb-3" id="deleteLayoutBtn" onclick="deleteSelectedTable()" style="display: none;">üóë Elimina Tavolo</button>
  </div>
  <button class="btn btn-success mb-3 mx-5" id="editLayoutBtn">‚úèÔ∏è Modifica Layout</button>
    <button class="btn btn-success mb-3 mx-5" id="saveLayoutBtn" style="display:none">üíæ Salva Modifiche</button>
  </div>
    <!--<button onclick="resetLayout()">‚Ü∫ Reset</button>--> 
    <form id="bgForm" enctype="multipart/form-data" style="display:inline">
      <input type="file" id="bgInput" name="background" accept="image/*" style="display:none">
    </form>
</div>



  <div id="floorplan"></div>

  <!-- Modal modifica tavolo -->
  <div id="editModal" class="fade-modal">
    <div class="modal-content">
      <h3>Modifica Tavolo</h3>
      <label>Nome Tavolo</label>
      <input type="text" id="modalName">
      <label>Posti</label>
      <input type="number" id="modalSeats" min="1">
      <label>Posizione (descrizione)</label>
      <input type="text" id="modalPosizione" placeholder="Es. Angolo, Centro Sala">
      <label>Forma</label>
      <select id="modalShape">
        <option value="rect">Rettangolare</option>
        <option value="square">Quadrato</option>
        <option value="circle">Rotondo</option>
      </select>
      <button id="modalSave">Salva</button>
      <button id="modalCancel">Annulla</button>
    </div>
  </div>
<!-- Info Modal -->
<div id="InfoModal" class="fade-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:9999;">
  <div class="modal-content align-items-center text-center" style="background:#222; padding:20px; border-radius:12px; color:white; width:320px; text-align:center;">
    <h3>‚ö†Ô∏è Attenzione ‚ö†Ô∏è</h3>
    <p id="InfoModalLabel"></p>
    <button class="btn btn-danger text-center align-items-center" id="InfoModalClose" style="display: flex; align-items: center; text-align: center;" >Chiudi</button>
  </div>
</div>
  <!-- Modal nuovo tavolo -->
  <div id="addTableModal" class="fade-modal">
    <div class="modal-content">
      <h3>Nuovo Tavolo</h3>
      <form id="addTableForm">
        <label>Nome Tavolo</label>
        <input type="text" name="nome_tavolo" required>
        <label>Posti</label>
        <input type="number" name="n_posti" min="1" required>
        <label>Posizione (descrizione)</label>
        <input type="text" name="posizione" placeholder="Es. Angolo, Centro Sala" required>
        <label>Posizione X</label>
        <input type="number" name="x" min="0" value="100" required>
        <label>Posizione Y</label>
        <input type="number" name="y" min="0" value="100" required>
        <label>Forma</label>
        <select name="shape">
          <option value="rect">Rettangolare</option>
          <option value="square">Quadrato</option>
          <option value="circle">Rotondo</option>
        </select>
        <div class="d-flex justify-content-between  mt-3 align-items-center text-center">
          <button type="button" class="btn btn-danger mb-3" id="addTableCancel">Annulla</button>
          <button type="submit" class="btn btn-success mb-3" id="addTableSubmit">Aggiungi</button>
        </div>
      </form>
    </div>
  </div>

<div>
<!-- Tabella dati -->
<table class="table-container glass-table align-items-center text-center mt-4">
  <thead>
    <tr>
      <th class="text-center">Nome</th>
      <th class="text-center">Posti</th>
      <th class="text-center">Posizione</th>
    </tr>
  </thead>
  <tbody>
    {% if tavoli %}
      {% for tavolo in tavoli %}
        <tr>
          <td>{{ tavolo['nome_tavolo'] }}</td>
          <td>{{ tavolo['n_posti'] }}</td>
          <td>{{ tavolo['posizione'] }}</td>
        </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="4" class="text-center">Nessun tavolo trovato.</td>
      </tr>
    {% endif %}
  </tbody>
</table>
</div>

<script>
// --- Variabili principali ---
const gridSize = 1;
const floorplan = document.getElementById("floorplan");
let selectedTableId = null;
let editMode = false;

const serverTables = [
  {% for tavolo in tavoli %}
    {
      id: "db{{ tavolo['id_tavolo'] }}",
      text: {{ tavolo['nome_tavolo']|tojson|safe }},
      x: {{ tavolo['x'] or 100 }},
      y: {{ tavolo['y'] or 100 }},
      w: {{ tavolo['width'] or 120 }},
      h: {{ tavolo['height'] or 60 }},
      shape: {{ (tavolo['shape'] or 'rect')|tojson|safe }},
      seats: {{ tavolo['n_posti'] }},
      posizione: {{ tavolo['posizione']|tojson|safe }}
    }{% if not loop.last %},{% endif %}
  {% endfor %}
];

// --- Utility ---
function snapToGrid(v){ return Math.round(v/gridSize)*gridSize; }

// --- Info Modal ---
function showInfoModal(message){
  const infoModal = document.getElementById("InfoModal");
  document.getElementById("InfoModalLabel").textContent = message;
  infoModal.style.display = "flex";
}
document.getElementById("InfoModalClose").onclick = () => {
  document.getElementById("InfoModal").style.display = "none";
};
window.onclick = (event) => {
  const modal = document.getElementById("InfoModal");
  if(event.target === modal){
    modal.style.display = "none";
  }
};

// --- Render tavoli ---
function renderTables(){
  floorplan.innerHTML="";
  serverTables.forEach(t=>{
    const div=document.createElement("div");
    div.className="table-tavoli shape-"+t.shape;
    div.id=t.id;
    div.dataset.text=t.text;
    div.dataset.shape=t.shape;
    div.dataset.seats=t.seats;
    div.dataset.posizione=t.posizione || "";
    div.textContent=t.text;
    div.style.left=t.x+"px";
    div.style.top=t.y+"px";
    div.style.width=t.w+"px";
    div.style.height=t.h+"px";

    const handle=document.createElement("div");
    handle.className="resize-handle";
    div.appendChild(handle);
    floorplan.appendChild(div);
    makeDraggableAndResizable(div);
  });
}

// --- Draggable/Resizable tavoli ---
function makeDraggableAndResizable(table){
  const handle=table.querySelector(".resize-handle");
  let offsetX, offsetY;

  table.onmousedown=e=>{
    if(!editMode || e.target===handle){
      showInfoModal("Layout non modificabile! Devi cliccare su ‚úèÔ∏è Modifica Layout.");
      return;
    }
    e.preventDefault();
    offsetX=e.clientX-table.offsetLeft;
    offsetY=e.clientY-table.offsetTop;
    document.onmousemove=e2=>{
      let newX=Math.max(0,Math.min(floorplan.clientWidth-table.offsetWidth,e2.clientX-offsetX));
      let newY=Math.max(0,Math.min(floorplan.clientHeight-table.offsetHeight,e2.clientY-offsetY));
      table.style.left=snapToGrid(newX)+"px";
      table.style.top=snapToGrid(newY)+"px";
    };
    document.onmouseup=()=>{document.onmousemove=null;};
  };

  handle.onmousedown=e=>{
    if(!editMode){
      showInfoModal("Layout non modificabile! Devi cliccare su ‚úèÔ∏è Modifica Layout.");
      return;
    }
    e.stopPropagation();
    let startX=e.clientX,startY=e.clientY,startW=table.offsetWidth,startH=table.offsetHeight;
    document.onmousemove=e2=>{
      let newW=Math.max(40,snapToGrid(startW+(e2.clientX-startX)));
      let newH=Math.max(40,snapToGrid(startH+(e2.clientY-startY)));
      table.style.width=newW+"px";
      table.style.height=newH+"px";
    };
    document.onmouseup=()=>{document.onmousemove=null;};
  };

  table.onclick=()=>{
    document.querySelectorAll(".table-tavoli").forEach(t=>t.classList.remove("selected"));
    table.classList.add("selected");
    selectedTableId=table.id;
  };
  table.ondblclick=()=>openEditModal(table.id);
}

// --- Modal modifica tavolo ---
const modal=document.getElementById("editModal");
const modalName=document.getElementById("modalName");
const modalSeats=document.getElementById("modalSeats");
const modalShape=document.getElementById("modalShape");
const modalPosizione=document.getElementById("modalPosizione");
let currentEditId=null;

function openEditModal(id){
  const table=serverTables.find(t=>t.id===id);
  if(!table) return;
  currentEditId=id;
  modalName.value=table.text;
  modalSeats.value=table.seats;
  modalShape.value=table.shape;
  modalPosizione.value=table.posizione || "";
  modal.style.display="flex";
}
document.getElementById("modalCancel").onclick=()=>modal.style.display="none";

document.getElementById("modalSave").onclick=async ()=>{
  if(!currentEditId) return;
  const table=serverTables.find(t=>t.id===currentEditId);
  table.text=modalName.value;
  table.seats=parseInt(modalSeats.value)||1;
  table.shape=modalShape.value;
  table.posizione=modalPosizione.value || "default";

  if(table.shape==="square"||table.shape==="circle"){
    const side=Math.max(table.w,table.h);
    table.w=side; table.h=side;
  }
  modal.style.display="none";
  renderTables();

  await fetch(`/tavoli/modifica/${table.id.replace("db","")}`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      nome_tavolo: table.text,
      n_posti: table.seats,
      posizione: table.posizione,
      shape: table.shape,
      x: parseInt(document.getElementById(table.id).style.left),
      y: parseInt(document.getElementById(table.id).style.top),
      w: table.w,
      h: table.h
    })
  });
  currentEditId=null;
};

// --- Modal nuovo tavolo ---
const addModal=document.getElementById("addTableModal");
document.getElementById("addTableCancel").onclick=()=>addModal.style.display="none";
function openAddTableModal(){ addModal.style.display="flex"; }

document.getElementById("addTableForm").onsubmit=async function(e){
  e.preventDefault();
  const formData=new FormData(this);
  const data={
    nome_tavolo: formData.get("nome_tavolo"),
    n_posti: parseInt(formData.get("n_posti")),
    posizione: formData.get("posizione"),
    x: parseInt(formData.get("x")),
    y: parseInt(formData.get("y")),
    shape: formData.get("shape")
  };
  const res=await fetch("/tavoli/nuovo",{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(data) });
  if(res.ok){
    addModal.style.display="none";
    data.id="db"+Date.now();
    data.text=data.nome_tavolo;
    data.seats=data.n_posti;
    data.w=120; data.h=60;
    serverTables.push(data);
    location.reload();
    renderTables();
  } else { showInfoModal("Errore durante l'aggiunta del tavolo."); }
};

// --- Altre funzioni ---
async function deleteSelectedTable(){
  if(!selectedTableId) return showInfoModal("Seleziona un tavolo!");
  const id=parseInt(selectedTableId.replace("db",""));
  await fetch(`/tavoli/elimina/${id}`,{method:"POST"});
  serverTables.splice(serverTables.findIndex(t=>t.id===selectedTableId),1);
  selectedTableId=null;
  renderTables();
}
function resetLayout(){ location.reload(); }
async function pushTablesToServer(){
  const tables=Array.from(document.querySelectorAll(".table-tavoli")).map(t=>({
    id:t.id.replace("db",""),
    nome_tavolo:t.dataset.text,
    n_posti:parseInt(t.dataset.seats),
    posizione:t.dataset.posizione || "",
    x:parseInt(t.style.left),
    y:parseInt(t.style.top),
    w:parseInt(t.offsetWidth),
    h:parseInt(t.offsetHeight),
    shape:t.dataset.shape
  }));
  await fetch("/tavoli/update-layout",{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(tables) });
  showInfoModal("‚úÖ Layout salvato!");
}

// --- Background ---
document.getElementById("bgInput").addEventListener("change",async e=>{
  const formData=new FormData(document.getElementById("bgForm"));
  const res=await fetch("/upload-bg",{method:"POST", body:formData});
  const data=await res.json();
  floorplan.style.background=`url(${data.url}) no-repeat center center / cover`;
  location.reload();
});

// --- Edit layout buttons ---
document.getElementById("editLayoutBtn").onclick=()=>{
  editMode=true;
  document.getElementById("saveLayoutBtn").style.display="inline-block";
  document.getElementById("editLayoutBtn").style.display="none";
  document.getElementById("deleteLayoutBtn").style.display="inline-block";
  showInfoModal("‚úèÔ∏è Modalit√† modifica attiva: sposta e ridimensiona i tavoli!");
};
document.getElementById("saveLayoutBtn").onclick=async ()=>{
  await pushTablesToServer();
  editMode=false;
  document.getElementById("editLayoutBtn").style.display="inline-block";
  document.getElementById("deleteLayoutBtn").style.display="none";
  document.getElementById("saveLayoutBtn").style.display="none";
};

// --- Render iniziale ---
renderTables();
</script>
{% endblock %}
