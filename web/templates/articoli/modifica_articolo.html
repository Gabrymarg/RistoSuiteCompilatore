{% extends "base.html" %}
{% block content %}
<h2>Modifica Articolo</h2>
<form method="POST">
    <div class="mb-3">
        <label>Nome</label>
        <input type="text" name="nome" class="form-control" value="{{ articolo['nome'] }}" required>
    </div>
    <div class="mb-3">
        <label>Descrizione</label>
        <textarea name="descrizione" class="form-control">{{ articolo['descrizione'] }}</textarea>
    </div>
    <div class="mb-3">
        <label>Prezzo</label>
        <input type="number" step="0.01" name="prezzo" class="form-control" value="{{ articolo['prezzo'] }}" min="0" required>
    </div>

    <div class="mb-3">
        <label>Categoria</label>
        <select name="categoria" class="form-select">
            <option value="">-- Nessuna categoria --</option>
            {% for cat in categorie %}
                <option value="{{ cat['id_categoria'] }}" {% if articolo['id_categoria'] == cat['id_categoria'] %}selected{% endif %}>
                    {{ cat['nome'] }}
                </option>
            {% endfor %}
        </select>
    </div>

    <h4>Ingredienti</h4>
    <p>Seleziona gli ingredienti e modifica la quantità se necessario:</p>

    <!-- Barra di ricerca ingredienti -->
    <input type="text" id="searchIngredienti" class="form-control mb-2" placeholder="Cerca ingrediente..." onkeyup="filterIngredienti()">

    <ul class="list-group mb-3" id="ingredientiList">
        {% for ingr in ingredienti %}
        {% set qta = articoli_ingredienti.get(ingr['id_ingrediente'], 0) %}
        <li class="list-group-item align-items-center" style="display: flex;">
            <!-- Checkbox ingrediente -->
            <input class="form-check-input me-2" 
                   type="checkbox" 
                   id="ingr{{ ingr['id_ingrediente'] }}" 
                   name="ingredienti" 
                   value="{{ ingr['id_ingrediente'] }}" 
                   {% if qta|float > 0 %}checked{% endif %}>

            <label class="form-check-label flex-grow-1" for="ingr{{ ingr['id_ingrediente'] }}">
                {{ ingr['nome'] }}
            </label>

            {% if usa_giacenza %}
                <!-- Campo quantità coerente col backend -->
                <input type="number" 
                       step="0.01" 
                       min="0" 
                       name="quantita_ingredienti_{{ ingr['id_ingrediente'] }}" 
                       class="form-control" 
                       style="width: 100px;" 
                       placeholder="Quantità" 
                       value="{{ qta if qta|float > 0 else '' }}">
            {% endif %}
        </li>
        {% endfor %}
        <li id="noIngredientiMsg" class="list-group-item text-center" style="display:none;">Nessun ingrediente trovato.</li>
    </ul>

    <button class="btn btn-primary">Aggiorna</button>
</form>

<script>
function filterIngredienti() {
    const input = document.getElementById('searchIngredienti');
    const filter = input.value.toLowerCase();
    const ul = document.getElementById('ingredientiList');
    const items = ul.getElementsByTagName('li');
    let found = false;

    for (let i = 0; i < items.length; i++) {
        const item = items[i];
        if (item.id === "noIngredientiMsg") continue;

        const label = item.querySelector('label');
        const text = label.textContent.toLowerCase();

        if (text.includes(filter)) {
            item.style.display = "flex"; // mostra li
            found = true;
        } else {
            item.style.display = "none"; // nascondi li
        }
    }

    // Mostra messaggio se nessun risultato
    document.getElementById('noIngredientiMsg').style.display = found ? "none" : "block";
}
</script>
{% endblock %}
