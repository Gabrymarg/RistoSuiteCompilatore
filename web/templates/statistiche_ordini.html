{% extends "base.html" %}
{% block content %}

<div id="section-analisi" class="content-section">
    <div class="card p-4 rounded-4 shadow-sm container">
        <h4 class="mb-3">üìà Analisi Vendite</h4>
        <p class="text-muted">Statistiche aggiornate su incassi, ordini e trend.</p>

        <!-- Statistiche Oggi -->
        <div class="row g-3 mb-4 text-center">
            <div class="col-md-3">
                <div class="card bg-primary text-white rounded-4 shadow-sm p-3 stat-card">
                    <h6><i class="bi bi-cash-coin"></i> Incasso Oggi</h6>
                    <h3>‚Ç¨{{ incasso_oggi }}</h3>
                    <small>Dall'apertura alla chiusura</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white rounded-4 shadow-sm p-3 stat-card">
                    <h6><i class="bi bi-receipt"></i> Ordini Oggi</h6>
                    <h3>{{ ordini_oggi }}</h3>
                    <small>Dall'apertura alla chiusura</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark rounded-4 shadow-sm p-3 stat-card">
                    <h6><i class="bi bi-basket"></i> Scontrino Medio Oggi</h6>
                    <h3>‚Ç¨{{ scontrino_oggi }}</h3>
                    <small>Dall'apertura alla chiusura</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-secondary text-white rounded-4 shadow-sm p-3 stat-card">
                    <h6><i class="bi bi-clock-history"></i> Tempo Medio Oggi</h6>
                    <h3>{{ tempo_oggi }}</h3>
                    <small>Dall'apertura alla chiusura</small>
                </div>
            </div>
        </div>

        <!-- Statistiche Settimanali -->
        <div class="row g-3 mb-4 text-center">
            <div class="col-md-3">
                <div class="card bg-primary text-white rounded-4 shadow-sm p-3 stat-card">
                    <h6>Incasso Settimana</h6>
                    <h3>‚Ç¨{{ incasso_settimana }}</h3>
                    <small class="{% if incasso_var|float >= 0 %}text-success{% else %}text-danger{% endif %} fw-semibold">
                        {{ incasso_var }}% vs settimana scorsa
                    </small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white rounded-4 shadow-sm p-3 stat-card">
                    <h6>Ordini Settimana</h6>
                    <h3>{{ ordini_settimana }}</h3>
                    <small class="{% if ordini_var|float >= 0 %}text-success{% else %}text-danger{% endif %} fw-semibold">
                        {{ ordini_var }}% vs settimana scorsa
                    </small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark rounded-4 shadow-sm p-3 stat-card">
                    <h6>Scontrino Medio</h6>
                    <h3>‚Ç¨{{ scontrino_medio }}</h3>
                    <small class="{% if scontrino_var|float >= 0 %}text-success{% else %}text-danger{% endif %} fw-semibold">
                        {{ scontrino_var }}% vs settimana scorsa
                    </small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-secondary text-white rounded-4 shadow-sm p-3 stat-card">
                    <h6>Tempo Medio</h6>
                    <h3>{{ tempo_medio }}</h3>
                    <small class="{% if tempo_var|float <= 0 %}text-success{% else %}text-danger{% endif %} fw-semibold">
                        {{ tempo_var }} vs settimana scorsa
                    </small>
                </div>
            </div>
        </div>

        <!-- Grafici -->
        <div class="row g-4">
            <!-- Vendite Settimanali -->
            <div class="col-md-7">
                <div class="card shadow-sm rounded-4 p-3">
                    <h5 class="card-title mb-3">üìä Vendite Settimanali</h5>
                    {% if vendite_labels and vendite_dati %}
                        <div style="height: 350px;">
                            <canvas id="venditeChart"></canvas>
                        </div>
                    {% else %}
                        <p class="text-muted">Nessun dato disponibile</p>
                    {% endif %}
                </div>
            </div>

            <!-- Ordini per Categoria -->
            <div class="col-md-5">
                <div class="card shadow-sm rounded-4 p-3">
                    <h5 class="card-title mb-3">üì¶ Ordini per Categoria</h5>
                    {% if categorie_labels and categorie_dati %}
                        <div style="height: 350px;">
                            <canvas id="categoriaChart"></canvas>
                        </div>
                    {% else %}
                        <p class="text-muted">Nessun dato disponibile</p>
                    {% endif %}
                </div>
            </div>

            <!-- Ordini per Ora -->
            <div class="col-md-7">
                <div class="card shadow-sm rounded-4 p-3">
                    <h5 class="card-title mb-3">üïí Ordini per Ora</h5>
                    {% if ore_labels and ore_dati %}
                        <div style="height: 300px;">
                            <canvas id="ordiniOraChart"></canvas>
                        </div>
                    {% else %}
                        <p class="text-muted">Nessun dato disponibile</p>
                    {% endif %}
                </div>
            </div>

            <!-- Top Prodotti -->
            <div class="col-md-5">
                <div class="card shadow-sm rounded-4 p-3">
                    <h5 class="card-title mb-3">üèÜ Articoli Pi√π Venduti (Top 10)</h5>
                    {% if top_prodotti %}
                        <div style="height: 350px;">
                            <canvas id="topProdottiChart"></canvas>
                        </div>
                    {% else %}
                        <p class="text-muted">Nessun dato disponibile</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Gradient helper
function createGradient(ctx, color1, color2) {
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, color1);
    gradient.addColorStop(1, color2);
    return gradient;
}

// Vendite Settimanali
{% if vendite_labels and vendite_dati %}
const ctxVendite = document.getElementById('venditeChart').getContext('2d');
new Chart(ctxVendite, {
    type: 'bar',
    data: {
        labels: {{ vendite_labels | tojson }},
        datasets: [{
            label: 'Vendite (‚Ç¨)',
            data: {{ vendite_dati | tojson }},
            backgroundColor: createGradient(ctxVendite, 'rgba(54, 162, 235, 0.8)', 'rgba(54, 162, 235, 0.2)'),
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    },
    options: {
        indexAxis: 'x',
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: { beginAtZero: true, title: { display: true, text: 'Totale Vendite (‚Ç¨)' } },
            y: { title: { display: true, text: 'Giorno della settimana' } }
        },
        plugins: { legend: { display: false } }
    }
});
{% endif %}

// Categoria (Pie)
{% if categorie_labels and categorie_dati %}
new Chart(document.getElementById('categoriaChart'), {
    type: 'pie',
    data: {
        labels: {{ categorie_labels | tojson }},
        datasets: [{
            data: {{ categorie_dati | tojson }},
            backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#8BC34A','#FF9800','#9C27B0','#00BCD4']
        }]
    },
    options: { responsive: true, maintainAspectRatio: false }
});
{% endif %}

// Ordini per Ora
{% if ore_labels and ore_dati %}
const ctxOra = document.getElementById('ordiniOraChart').getContext('2d');
new Chart(ctxOra, {
    type: 'line',
    data: {
        labels: {{ ore_labels | tojson }},
        datasets: [{
            label: 'Ordini',
            data: {{ ore_dati | tojson }},
            borderColor: '#FF6384',
            backgroundColor: createGradient(ctxOra, 'rgba(255,99,132,0.5)', 'rgba(255,99,132,0.1)'),
            fill: true,
            tension: 0.3
        }]
    },
    options: { responsive: true, maintainAspectRatio: false }
});
{% endif %}

// Top Prodotti
{% if top_prodotti %}
const ctxTop = document.getElementById('topProdottiChart').getContext('2d');
new Chart(ctxTop, {
    type: 'bar',
    data: {
        labels: {{ top_prodotti | map(attribute='nome') | list | tojson }},
        datasets: [{
            label: 'Quantit√† vendute',
            data: {{ top_prodotti | map(attribute='quantita') | list | tojson }},
            backgroundColor: createGradient(ctxTop, 'rgba(75, 192, 192, 0.8)', 'rgba(75,192,192,0.2)'),
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: { beginAtZero: true, title: { display: true, text: 'Quantit√† vendute' } },
            y: { title: { display: true, text: 'Prodotti' } }
        },
        plugins: { legend: { display: false } }
    }
});
{% endif %}
</script>

<!-- CSS Extra -->
<style>
    .stat-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.8rem 1.2rem rgba(0,0,0,0.15);
    }
</style>

{% endblock %}
